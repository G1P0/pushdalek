# pushdalek

Telegram-бот для парсинга случайных постов с фото из VK-стены в Telegram.

## Что умеет

- Забирает посты со стены VK-группы
- Берёт только посты **с фото**
- Один VK-пост → **одно сообщение в Telegram**
  - 1 фото → обычное фото
  - 2–10 фото → альбом (media group)
  - 10+ фото → берём первые 10 (лимит Telegram)
- Добавляет к посту тег архива (например `#архив`) и ссылку на оригинал VK
- Ведёт учёт статусов в SQLite:
  - `new` — ещё не публиковалось
  - `used` — уже опубликовано

## Команды бота

- `/start` или `/help` — меню/подсказка
- `/sync` — синхронизировать последние посты (дефолт - 100) из VK в базу
- `/next` — отправить случайный `new` пост и пометить как `used`
- `/used [N]` — показать последние `used` (по умолчанию 5)
- `/whoami` — показать `user_id` и `chat_id`

## Конфигурация (.env)

Пример `.env`:

```env
TG_BOT_TOKEN=...
TG_ADMIN_IDS=123,456

VK_TOKEN=...
VK_OWNER_ID=-123456

DB_PATH=bot.db
ARCHIVE_TAG=#архив
````

Переменные:

* `TG_BOT_TOKEN` — токен Telegram-бота
* `TG_ADMIN_IDS` — список user_id админов через запятую (берутся с /whoami)
* `VK_TOKEN` — токен VK
* `VK_OWNER_ID` — owner_id стены (для группы обычно отрицательный)
* `DB_PATH` — путь к SQLite базе (по умолчанию `bot.db`)
* `ARCHIVE_TAG` — тег, который добавляется к постам (по умолчанию `#архив`)

## Структура проекта

* `cmd/`

  * `bot/` — основной запуск бота
  * `sync/` — ручной sync из VK в DB (опционально, для отладки - или для первичной инициации если надо вгрузить библиотеку)
  * `vkcheck/` — проверка парсинга VK (опционально)
* `internal/`

  * `vk/` — клиент VK API + извлечение фото/постов
  * `store/` — SQLite-хранилище (посты, статусы, выборка)
  * `config/` — загрузка env (если используется)

## Запуск

### 1. Установить env

Либо экспортом переменных, либо через `.env`.

`set -a; source .env; set +a`

### 2. Запустить sync

Нужно для первичной загрузки всей базы (выставь значение 0 в `FetchWall`). 

```bash
go run ./cmd/sync
```

### 3. Запустить бота

```bash
go run ./cmd/bot
```

### 4. В Telegram

1. Напиши боту `/whoami` (доступно всем) и возьми `user_id`.

2. Добавь этот `user_id` в `.env`:

```
TG_ADMIN_IDS=123456789 # можно через запятую несколько
```

3. Перезапусти бота.

4.  Открой чат с ботом и используй команды/кнопки:
  - `/start` (меню)
  - `/sync` (загрузить последние посты из VK)
  - `/next` (получить случайный пост)

## Примечания

* Бот отправляет пост **в тот чат**, где вызываешь команды.
